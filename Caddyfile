# Сниппет с общими заголовками безопасности и логированием
(common) {
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }
    log {
        output file /var/log/caddy/{host}.log
        format json
    }
    encode gzip zstd
}

# Сниппет с общими параметрами reverse_proxy
(proxy) {
    reverse_proxy {upstream} {
        header_up Host {host}
        header_up X-Real-IP {http.request.remote.host}
        header_up X-Forwarded-For {http.request.remote.host}
        header_up X-Forwarded-Proto {scheme}
        transport http {
            keepalive 30s
            response_header_timeout 30s
            read_timeout 30s
            write_timeout 30s
            dial_timeout 30s
        }
    }
}

# Редирект с www на основной домен
www.fasti.fun {
    redir https://fasti.fun{uri} permanent
}

# Основной фронтенд
fasti.fun {
    import common

    root * /usr/share/nginx/html
    file_server

    import proxy {
        upstream frontend:3000
    }

    header {
        Content-Security-Policy "
            default-src 'self';
            script-src 'self' 'unsafe-inline';
            style-src 'self' 'unsafe-inline';
            connect-src 'self' fasti.fun api.fasti.fun raw.githubusercontent.com ton.org;
            img-src 'self' data: telegram.org ton.org githubusercontent.com raw.githubusercontent.com;
            frame-ancestors 'self';
            object-src 'none';
        "
    }

    tls {
        protocols tls1.2 tls1.3
    }
}

# API backend
api.fasti.fun {
    import common
    import proxy {
        upstream api:4000
    }
    header {
        Content-Security-Policy "
            default-src 'self';
            img-src 'self' data:;
            style-src 'self' 'unsafe-inline';
            script-src 'self' 'unsafe-inline';
            connect-src 'self' fasti.fun api.fasti.fun;
            frame-ancestors 'self';
        "
    }
}

# Grafana
grafana.fasti.fun {
    import common
    import proxy {
        upstream grafana:3000
    }
    header {
        Content-Security-Policy "
            default-src 'self';
            img-src 'self' data:;
            style-src 'self' 'unsafe-inline';
            script-src 'self' 'unsafe-inline';
            connect-src 'self' grafana.fasti.fun;
            frame-ancestors 'self';
        "
    }
}

# Prometheus
prometheus.fasti.fun {
    import common
    import proxy {
        upstream prometheus:9090
    }
    header {
        Content-Security-Policy "
            default-src 'self';
            img-src 'self' data:;
            style-src 'self' 'unsafe-inline';
            script-src 'self' 'unsafe-inline';
            connect-src 'self' prometheus.fasti.fun;
            frame-ancestors 'self';
        "
    }
}

# xray-checker
xray-checker.fasti.fun {
    import common
    import proxy {
        upstream xray-checker:2112
    }
    header {
        Content-Security-Policy "
            default-src 'self';
            img-src 'self' data:;
            style-src 'self' 'unsafe-inline';
            script-src 'self' 'unsafe-inline';
            connect-src 'self' prometheus.fasti.fun;
            frame-ancestors 'self';
        "
    }
}

# Uptime Kuma
status.fasti.fun {
    import common
    import proxy {
        upstream uptime-kuma:3001
    }
    header {
        Content-Security-Policy "
            default-src 'self';
            img-src 'self' data:;
            style-src 'self' 'unsafe-inline';
            script-src 'self' 'unsafe-inline';
            connect-src 'self' status.fasti.fun;
            frame-ancestors 'self';
        "
    }
}
