# Перенаправление с www на основной домен
www.fasti.fun {
    redir https://fasti.fun{uri} permanent
}

# Основной фронтенд
fasti.fun {
    root * /usr/share/nginx/html
    file_server

    reverse_proxy frontend:3000 {
        header_up Host {host}
        header_up X-Real-IP {http.request.remote.host}
        header_up X-Forwarded-For {http.request.remote.host}
        header_up X-Forwarded-Proto {scheme}
        transport http {
            keepalive 60s
						response_header_timeout 60s
						read_timeout 60s
						write_timeout 60s
						dial_timeout 30s
        }
    }

    encode gzip zstd

    log {
        output file /var/log/caddy/access.log
        format json
    }

    header {
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options "nosniff"
        Content-Security-Policy "
					default-src 'self';
					script-src 'self' 'unsafe-inline';
					style-src 'self' 'unsafe-inline';
					connect-src 'self' fasti.fun api.fasti.fun raw.githubusercontent.com ton.org;
					img-src 'self' data: telegram.org ton.org githubusercontent.com raw.githubusercontent.com;
					frame-ancestors 'self';
					object-src 'none';
				"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }

    tls {
        protocols tls1.2 tls1.3
    }
}

# API backend
api.fasti.fun {
    reverse_proxy api:4000 {
        header_up Host {host}
        header_up X-Real-IP {http.request.remote.host}
        header_up X-Forwarded-For {http.request.remote.host}
        header_up X-Forwarded-Proto {scheme}
        transport http {
            keepalive 180s
						response_header_timeout 180s
						read_timeout 180s
						write_timeout 180s
						dial_timeout 180s
        }
    }

    encode gzip zstd

    log {
        output file /var/log/caddy/api.log
        format json
    }

    header {
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options "nosniff"
        Content-Security-Policy "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' fasti.fun api.fasti.fun; frame-ancestors 'self';"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }
}

# Grafana
grafana.fasti.fun {
    reverse_proxy grafana:3000 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        transport http {
            keepalive 30s
            response_header_timeout 30s
            read_timeout 30s
            write_timeout 30s
            dial_timeout 30s
        }
    }

    encode gzip zstd

    log {
        output file /var/log/caddy/grafana.log
        format json
    }

    header {
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options "nosniff"
        Content-Security-Policy "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' grafana.fasti.fun; frame-ancestors 'self';"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }
}

# Prometheus (если используешь)
prometheus.fasti.fun {
    reverse_proxy prometheus:9090 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        transport http {
            keepalive 30s
            response_header_timeout 30s
            read_timeout 30s
            write_timeout 30s
            dial_timeout 30s
        }
    }

    encode gzip zstd

    log {
        output file /var/log/caddy/prometheus.log
        format json
    }

    header {
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options "nosniff"
        Content-Security-Policy "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' prometheus.fasti.fun; frame-ancestors 'self';"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }
}

xray-checker.fasti.fun {
    reverse_proxy xray-checker:2112 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        transport http {
            keepalive 30s
            response_header_timeout 30s
            read_timeout 30s
            write_timeout 30s
            dial_timeout 30s
        }
    }

    encode gzip zstd

    log {
        output file /var/log/caddy/xray-checker.log
        format json
    }

    header {
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options "nosniff"
        Content-Security-Policy "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' prometheus.fasti.fun; frame-ancestors 'self';"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }
}

status.fasti.fun {
    reverse_proxy uptime-kuma:8080 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        transport http {
            keepalive 30s
            response_header_timeout 30s
            read_timeout 30s
            write_timeout 30s
            dial_timeout 30s
        }
    }

    encode gzip zstd

    log {
        output file /var/log/caddy/uptime-kuma.log
        format json
    }

    header {
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options "nosniff"
        Content-Security-Policy "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' prometheus.fasti.fun; frame-ancestors 'self';"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }
}
