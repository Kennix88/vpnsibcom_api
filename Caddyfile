{
    # Глобальные настройки TLS
    tls {
        protocols tls1.2 tls1.3
        ciphers TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        curves x25519 secp521r1 secp384r1
    }

    # Глобальное сжатие
    encode gzip zstd
}

# Общие настройки безопасности
(security_headers) {
    header {
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        -Server
    }
}

# Настройки логгирования
(log_settings) {
    log {
        output file /var/log/caddy/{host}.access.log {
            roll_size 100MiB
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }
}

# Настройки транспорта для разных типов сервисов
(transport_fast) {
    transport http {
        keepalive 30s
        response_header_timeout 30s
        read_timeout 30s
        write_timeout 30s
        dial_timeout 30s
    }
}

(transport_api) {
    transport http {
        keepalive 180s
        response_header_timeout 180s
        read_timeout 180s
        write_timeout 180s
        dial_timeout 180s
    }
}

# Перенаправление с www на основной домен
www.fasti.fun {
    redir https://fasti.fun{uri} permanent
}

# Основной фронтенд
fasti.fun {
    root * /usr/share/nginx/html
    file_server

    reverse_proxy frontend:3000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        import transport_fast
    }

    import security_headers
    header Content-Security-Policy "
        default-src 'self';
        script-src 'self' 'unsafe-inline';
        style-src 'self' 'unsafe-inline';
        connect-src 'self' fasti.fun api.fasti.fun raw.githubusercontent.com ton.org;
        img-src 'self' data: telegram.org ton.org githubusercontent.com raw.githubusercontent.com;
        frame-ancestors 'self';
        object-src 'none';
    "

    import log_settings
}

# API backend
api.fasti.fun {
    reverse_proxy api:4000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        import transport_api
    }

    import security_headers
    header Content-Security-Policy "
        default-src 'self';
        script-src 'self' 'unsafe-inline';
        style-src 'self' 'unsafe-inline';
        connect-src 'self' fasti.fun api.fasti.fun;
        img-src 'self' data:;
        frame-ancestors 'self';
        object-src 'none';
    "

    import log_settings
}

# Grafana
grafana.fasti.fun {
    reverse_proxy grafana:3000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        import transport_fast
    }

    import security_headers
    header Content-Security-Policy "
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data:;
        font-src 'self';
        connect-src 'self' grafana.fasti.fun;
        frame-ancestors 'self';
    "

    import log_settings
}

# Prometheus
prometheus.fasti.fun {
    reverse_proxy prometheus:9090 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        import transport_fast
    }

    import security_headers
    header Content-Security-Policy "
        default-src 'self';
        script-src 'self' 'unsafe-inline';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data:;
        connect-src 'self' prometheus.fasti.fun;
        frame-ancestors 'self';
    "

    import log_settings
}

# xray-checker
xray-checker.fasti.fun {
    reverse_proxy xray-checker:2112 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        import transport_fast
    }

    import security_headers
    header Content-Security-Policy "
        default-src 'self';
        script-src 'self' 'unsafe-inline';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data:;
        connect-src 'self' xray-checker.fasti.fun;
        frame-ancestors 'self';
    "

    import log_settings
}

# Uptime Kuma
status.fasti.fun {
    reverse_proxy uptime-kuma:3001 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        import transport_fast
    }

    import security_headers
    header Content-Security-Policy "
        default-src 'self';
        script-src 'self' 'unsafe-inline';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data:;
        connect-src 'self' status.fasti.fun;
        frame-ancestors 'self';
    "

    import log_settings
}