{
    # Глобальные настройки
    auto_https on
    admin off
    log {
        level INFO
    }
}

# Общие шаблоны
(security_headers) {
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        -Server
    }
}

(tls_settings) {
    tls {
        protocols tls1.2 tls1.3
        ciphers TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
    }
}

(api_protection) {
    @postRequests method POST
    handle @postRequests {
        header Strict-Transport-Security "max-age=31536000;"
        header Access-Control-Allow-Origin https://fasti.fun
        header Access-Control-Allow-Methods "POST, OPTIONS"
        header Access-Control-Allow-Headers "*"
    }
}

# Перенаправление с www на основной домен
www.fasti.fun {
    redir https://fasti.fun{uri} permanent
}

http://fasti.fun {
    redir https://fasti.fun{uri} permanent
}

# Основной фронтенд
fasti.fun {
    import tls_settings
    import security_headers

    reverse_proxy frontend:3000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        transport http {
            keepalive 60s
        }
    }

    header Content-Security-Policy "
				default-src 'self';
				script-src 'self' 'unsafe-inline' 'unsafe-eval';
				style-src 'self' 'unsafe-inline';
				img-src 'self' data:;
				connect-src 'self' https://api.fasti.fun;
				frame-ancestors 'none';
				base-uri 'none';
		"

    log {
        output file /var/log/caddy/fasti.access.log {
            roll_size 100MB
            roll_keep 5
        }
        format json
    }
}


api.fasti.fun {
    import tls_settings
    import security_headers
		import api_protection

    reverse_proxy api:4000 {
        header_up Host {host}
        transport http {
						read_buffer 4096
						read_timeout 10s
						write_timeout 10s
						idle_timeout 30s
						keepalive 60s
				}
    }

    log {
        output file /var/log/caddy/api.access.log {
            roll_size 100MB
            roll_keep 5
        }
        format json
    }
}


# Grafana
grafana.fasti.fun {
    import tls_settings
    import security_headers

    reverse_proxy grafana:3000

    header Content-Security-Policy "
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data:;
    "
}

# Prometheus
prometheus.fasti.fun {
    import tls_settings
    import security_headers

    reverse_proxy prometheus:9090
}

# Xray-checker
xray-checker.fasti.fun {
    import tls_settings
    import security_headers

    reverse_proxy xray-checker:2112
}

# Uptime Kuma
status.fasti.fun {
    import tls_settings
    import security_headers

    reverse_proxy uptime-kuma:3001
}